<?php

function table_contents() {
  $titles = json_decode(stripslashes($_GET['titles']), true);
  $html = '';

  if ( $titles ) {
    $html .= '
      <div class="toc">
        <div class="toc__head float-u-sm-r d-f ai-c jc-fe br-l-u-sm-10 br-r-o-xs-10">
          <p class="col tc-w fw-b fs-16 ta-c order-u-sm-2">'. __('Table of contents', 'elegance') .'</p>
          <button type="button" class="toc__btn js-toc-btn"><svg width="23" height="28" viewBox="0 0 23 28" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18.5417 16.2948C18.5417 16.5559 18.4395 16.8062 18.2577 16.9909C18.0758 17.1755 17.8291 17.2792 17.5719 17.2792H10.164C9.90676 17.2792 9.6601 17.1755 9.47823 16.9909C9.29636 16.8062 9.19419 16.5559 9.19419 16.2948C9.19419 16.0337 9.29636 15.7833 9.47823 15.5987C9.6601 15.4141 9.90676 15.3104 10.164 15.3104H17.5719C17.8291 15.3104 18.0758 15.4141 18.2577 15.5987C18.4395 15.7833 18.5417 16.0337 18.5417 16.2948ZM17.5719 20.276H10.164C9.90676 20.276 9.6601 20.3798 9.47823 20.5644C9.29636 20.749 9.19419 20.9993 9.19419 21.2604C9.19419 21.5215 9.29636 21.7719 9.47823 21.9565C9.6601 22.1411 9.90676 22.2448 10.164 22.2448H17.5719C17.8291 22.2448 18.0758 22.1411 18.2577 21.9565C18.4395 21.7719 18.5417 21.5215 18.5417 21.2604C18.5417 20.9993 18.4395 20.749 18.2577 20.5644C18.0758 20.3798 17.8291 20.276 17.5719 20.276ZM17.5719 10.3448H10.164C9.90676 10.3448 9.6601 10.4485 9.47823 10.6331C9.29636 10.8177 9.19419 11.0681 9.19419 11.3292C9.19419 11.5902 9.29636 11.8406 9.47823 12.0252C9.6601 12.2098 9.90676 12.3135 10.164 12.3135H17.5719C17.8291 12.3135 18.0758 12.2098 18.2577 12.0252C18.4395 11.8406 18.5417 11.5902 18.5417 11.3292C18.5417 11.0681 18.4395 10.8177 18.2577 10.6331C18.0758 10.4485 17.8291 10.3448 17.5719 10.3448ZM22.9588 8.16156V24.4279C22.9577 25.3749 22.5866 26.2829 21.9269 26.9526C21.2671 27.6223 20.3726 27.9989 19.4396 28H8.29629C7.36328 27.9989 6.46879 27.6222 5.80905 26.9526C5.14932 26.2829 4.77821 25.3749 4.77716 24.4279V23.4107H4.14487C3.21186 23.4096 2.31737 23.0329 1.65763 22.3632C0.997891 21.6936 0.626788 20.7856 0.625732 19.8385V3.57213C0.626788 2.62507 0.997891 1.71711 1.65763 1.04744C2.31737 0.377764 3.21186 0.00107111 4.14487 0L15.2882 0C16.2212 0.00107111 17.1157 0.377764 17.7755 1.04744C18.4352 1.71711 18.8063 2.62507 18.8074 3.57213V4.58932H19.4396C20.3726 4.59038 21.2672 4.96709 21.9269 5.63682C22.5867 6.30654 22.9578 7.21456 22.9588 8.16167V8.16156ZM4.77716 21.4417V8.16167C4.77821 7.21461 5.14932 6.30665 5.80905 5.63698C6.46879 4.9673 7.36328 4.59061 8.29629 4.58954H16.868V3.57235C16.8676 3.14719 16.701 2.73956 16.4048 2.43892C16.1087 2.13828 15.7071 1.96918 15.2882 1.96875H4.14487C3.72608 1.96923 3.32457 2.13831 3.02844 2.4389C2.73232 2.73949 2.56574 3.14704 2.56527 3.57213V19.8383C2.56576 20.2634 2.73233 20.671 3.02846 20.9715C3.32459 21.2721 3.72608 21.4412 4.14487 21.4417H4.77716ZM21.0192 8.16167C21.0188 7.73657 20.8522 7.32902 20.556 7.02843C20.2599 6.72785 19.8584 6.55877 19.4396 6.55829H8.29629C7.8775 6.55877 7.476 6.72785 7.17987 7.02844C6.88374 7.32903 6.71717 7.73658 6.7167 8.16167V24.4279C6.71717 24.853 6.88374 25.2605 7.17987 25.5611C7.476 25.8617 7.8775 26.0308 8.29629 26.0312H19.4396C19.8584 26.0308 20.2599 25.8617 20.556 25.5611C20.8522 25.2605 21.0188 24.853 21.0192 24.4279V8.16167Z" fill="white"/></svg></button>
        </div>
        <ul class="toc__list pb-10 bg-pv fs-12 fw-m tc-w of-a">
    ';
    $i = 0;
    foreach ($titles as $title) {
      $html .= '<li><a href="#toc-'. ($i + 1) .'" class="d-b py-10 pr-10 tc-w tc-h-w js-toc '. ($title['tag'] === 'H3' ? 'pl-40' : 'pl-20') .'">'. $title['text'] .'</a></li>';
      $i++;
    }
    $html .= '
        </ul>
      </div>
    ';
  }

  wp_reset_query();
  echo json_encode([
    'html' => $html
  ]);

  wp_die();
}
add_action('wp_ajax_table_contents', 'table_contents');
add_action('wp_ajax_nopriv_table_contents', 'table_contents');
